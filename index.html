<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0,user-scalable=yes">
    <title>ManhvaUZ - O'zbek Tilida Manhvalar</title>
    <meta name="description" content="O'zbek tilida eng zo'r manhvalarni bepul o'qing. Turli janrlar, yangilanishlar va foydalanuvchi baholari.">
    <meta name="keywords" content="manhva, manga, uzbek, o'zbek, webtoon, comics">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#f5f5f5;
            --card:rgba(255,255,255,0.95);
            --text:#1a1a1a;
            --text-light:#666;
            --border:rgba(0,0,0,0.1);
            --primary:#667eea;
            --primary-dark:#5568d3;
            --glass:rgba(0,0,0,0.05);
            --success:#22c55e;
            --error:#ef4444;
            --gold:#ffd700;
            --silver:#c0c0c0;
            --bronze:#cd7f32;
            --header-height:70px;
        }
        [data-theme="dark"]{
            --bg:#0a0a0a;
            --card:rgba(20,20,20,0.95);
            --text:#e0e0e0;
            --text-light:#999;
            --border:rgba(255,255,255,0.1);
            --glass:rgba(255,255,255,0.05);
        }
        html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:var(--bg);
            color:var(--text);
            transition:background .3s,color .3s;
            line-height:1.6;
            overflow-x:hidden;
        }
        
        /* HEADER - Responsive */
        header{
            position:sticky;
            top:0;
            z-index:100;
            background:var(--card);
            backdrop-filter:blur(10px);
            box-shadow:0 2px 10px var(--border);
            height:var(--header-height);
        }
        nav{
            max-width:1200px;
            margin:0 auto;
            padding:0.8rem 1rem;
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:0.8rem;
            height:100%;
        }
        
        /* LOGO - Mobile Optimized */
        .logo{
            font-size:clamp(1.1rem, 4vw, 1.5rem);
            font-weight:800;
            background:linear-gradient(135deg,#667eea,#764ba2);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            cursor:pointer;
            display:flex;
            align-items:center;
            gap:0.5rem;
            padding:0.4rem 0.8rem;
            border-radius:12px;
            transition:all .3s;
            white-space:nowrap;
            flex-shrink:0;
        }
        .logo-icon{
            width:clamp(30px, 8vw, 40px);
            height:clamp(30px, 8vw, 40px);
            border-radius:10px;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
            transition:transform .3s;
            flex-shrink:0;
        }
        .logo:hover .logo-icon{transform:rotate(5deg) scale(1.05)}
        
        /* SEARCH - Mobile First */
        .search-wrapper{
            position:relative;
            flex:1;
            max-width:100%;
            min-width:0;
        }
        .search-box{
            padding:0.6rem 0.8rem;
            border-radius:8px;
            border:1px solid var(--border);
            background:var(--card);
            color:var(--text);
            width:100%;
            font-size:0.95rem;
            transition:all .2s;
        }
        .search-box:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(102,126,234,0.1);
        }
        .search-results{
            position:fixed;
            top:var(--header-height);
            left:0;
            right:0;
            margin:0.5rem;
            background:var(--card);
            border:1px solid var(--border);
            border-radius:8px;
            max-height:calc(100vh - var(--header-height) - 1rem);
            overflow-y:auto;
            box-shadow:0 10px 40px rgba(0,0,0,0.3);
            z-index:1000;
            display:none;
        }
        .search-results.show{display:block}
        .search-result-item{
            padding:0.8rem;
            cursor:pointer;
            display:flex;
            align-items:center;
            gap:0.8rem;
            border-bottom:1px solid var(--border);
            transition:all .2s;
        }
        .search-result-item:hover{background:var(--glass)}
        .search-result-cover{
            width:45px;
            height:60px;
            border-radius:4px;
            object-fit:cover;
            flex-shrink:0;
        }
        
        /* NAVIGATION BUTTONS - Mobile */
        .nav-actions{
            display:flex;
            gap:0.5rem;
            align-items:center;
            flex-shrink:0;
        }
        .btn{
            padding:0.6rem 1rem;
            border-radius:8px;
            border:none;
            cursor:pointer;
            font-weight:600;
            transition:all .2s;
            font-size:0.9rem;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:0.5rem;
            white-space:nowrap;
            min-height:44px;
        }
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .btn:active{transform:scale(0.95)}
        .btn-primary{
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:white;
        }
        .btn-primary:hover:not(:disabled){
            transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(102,126,234,0.4);
        }
        .btn-glass{
            background:var(--glass);
            border:1px solid var(--border);
            color:var(--text);
        }
        .btn-glass:hover{background:var(--border)}
        .btn-icon-only{
            padding:0.6rem;
            width:44px;
            height:44px;
        }
        .btn-text{display:inline}
        
        /* HAMBURGER MENU - Mobile Only */
        .hamburger{
            display:none;
            flex-direction:column;
            gap:4px;
            cursor:pointer;
            padding:0.5rem;
            width:44px;
            height:44px;
            align-items:center;
            justify-content:center;
            border-radius:8px;
            background:var(--glass);
            transition:all .3s;
        }
        .hamburger span{
            width:22px;
            height:2px;
            background:var(--text);
            border-radius:2px;
            transition:all .3s;
        }
        .hamburger.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}
        .hamburger.active span:nth-child(2){opacity:0}
        .hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(6px,-6px)}
        
        /* MOBILE MENU */
        .mobile-menu{
            position:fixed;
            top:var(--header-height);
            left:0;
            right:0;
            bottom:0;
            background:var(--card);
            z-index:99;
            padding:1rem;
            transform:translateX(-100%);
            transition:transform .3s;
            overflow-y:auto;
        }
        .mobile-menu.show{transform:translateX(0)}
        .mobile-menu-item{
            padding:1rem;
            margin-bottom:0.5rem;
            border-radius:8px;
            cursor:pointer;
            transition:all .2s;
            display:flex;
            align-items:center;
            gap:0.8rem;
            font-weight:600;
            min-height:56px;
        }
        .mobile-menu-item:hover{background:var(--glass)}
        .mobile-menu-item i{font-size:1.2rem;width:24px;text-align:center}
        
        /* USER AVATAR */
        .user-avatar{
            width:44px;
            height:44px;
            border-radius:50%;
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:white;
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            cursor:pointer;
            transition:all .2s;
            overflow:hidden;
            border:2px solid transparent;
            position:relative;
            flex-shrink:0;
        }
        .user-avatar:active{transform:scale(0.9)}
        .user-avatar img{
            width:100%;
            height:100%;
            object-fit:cover;
            position:absolute;
            top:0;
            left:0;
        }
        .theme-btn{
            width:44px;
            height:44px;
            border-radius:50%;
            background:var(--glass);
            border:1px solid var(--border);
            cursor:pointer;
            font-size:1.1rem;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .2s;
            flex-shrink:0;
        }
        .theme-btn:active{transform:scale(0.9)}
        
        /* USER DROPDOWN */
        .user-dropdown{
            position:fixed;
            top:calc(var(--header-height) + 0.5rem);
            right:0.5rem;
            background:var(--card);
            border:1px solid var(--border);
            border-radius:12px;
            padding:0.5rem;
            min-width:200px;
            box-shadow:0 10px 40px rgba(0,0,0,0.3);
            display:none;
            z-index:1000;
        }
        .user-dropdown.show{display:block}
        .dropdown-item{
            padding:0.8rem 1rem;
            cursor:pointer;
            border-radius:8px;
            transition:all .2s;
            display:flex;
            align-items:center;
            gap:0.8rem;
            min-height:48px;
        }
        .dropdown-item:hover{background:var(--glass)}
        .dropdown-item i{width:20px;text-align:center}
        
        /* MODALS - Mobile Optimized */
        .modal{
            display:none;
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.7);
            backdrop-filter:blur(5px);
            align-items:center;
            justify-content:center;
            z-index:2000;
            padding:1rem;
        }
        .modal.show{display:flex}
        .modal-content{
            background:var(--card);
            padding:1.5rem;
            border-radius:16px;
            max-width:400px;
            width:100%;
            box-shadow:0 20px 60px rgba(0,0,0,0.3);
            max-height:90vh;
            overflow-y:auto;
        }
        .auth-tabs{
            display:flex;
            gap:0.5rem;
            margin-bottom:1.5rem;
            border-bottom:2px solid var(--border);
        }
        .auth-tab{
            flex:1;
            padding:0.8rem;
            cursor:pointer;
            border:none;
            background:transparent;
            color:var(--text-light);
            font-weight:600;
            transition:all .2s;
            border-bottom:2px solid transparent;
            margin-bottom:-2px;
            font-size:0.95rem;
            min-height:48px;
        }
        .auth-tab.active{
            color:var(--primary);
            border-bottom-color:var(--primary);
        }
        .alert{
            padding:0.8rem;
            border-radius:8px;
            margin-bottom:1rem;
            display:none;
            font-size:0.9rem;
        }
        .alert.show{display:block}
        .alert-error{
            background:rgba(239,68,68,0.1);
            color:#ef4444;
            border:1px solid rgba(239,68,68,0.3);
        }
        .alert-success{
            background:rgba(34,197,94,0.1);
            color:#22c55e;
            border:1px solid rgba(34,197,94,0.3);
        }
        .form-group{margin-bottom:1rem}
        .form-group label{
            display:block;
            margin-bottom:0.5rem;
            font-weight:600;
            color:var(--text);
            font-size:0.95rem;
        }
        .form-input{
            width:100%;
            padding:0.8rem;
            border-radius:8px;
            border:1px solid var(--border);
            background:var(--card);
            color:var(--text);
            transition:all .2s;
            font-size:1rem;
            min-height:48px;
        }
        .form-input:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(102,126,234,0.1);
        }
        .password-toggle{position:relative}
        .toggle-password{
            position:absolute;
            right:10px;
            top:50%;
            transform:translateY(-50%);
            background:none;
            border:none;
            cursor:pointer;
            font-size:1.2rem;
            color:var(--text-light);
            padding:0.5rem;
            min-width:44px;
            min-height:44px;
        }
        
        /* PROFILE MODAL - Mobile Optimized */
        .profile-modal{
            display:none;
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.7);
            backdrop-filter:blur(5px);
            align-items:center;
            justify-content:center;
            z-index:2000;
            padding:0;
        }
        .profile-modal.show{display:flex}
        .profile-modal-content{
            background:var(--card);
            border-radius:20px 20px 0 0;
            max-width:500px;
            width:100%;
            max-height:95vh;
            overflow-y:auto;
            box-shadow:0 20px 60px rgba(0,0,0,0.3);
            animation:slideUp .3s;
            margin-top:auto;
        }
        @keyframes slideUp{
            from{opacity:0;transform:translateY(100%)}
            to{opacity:1;transform:translateY(0)}
        }
        .profile-header{
            background:linear-gradient(135deg,#667eea,#764ba2);
            padding:2rem 1rem;
            text-align:center;
            border-radius:20px 20px 0 0;
        }
        .profile-avatar-large{
            width:clamp(80px, 20vw, 100px);
            height:clamp(80px, 20vw, 100px);
            border-radius:50%;
            background:white;
            color:var(--primary);
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:clamp(2rem, 5vw, 2.5rem);
            font-weight:700;
            margin:0 auto 1rem;
            overflow:hidden;
            border:4px solid white;
            box-shadow:0 4px 20px rgba(0,0,0,0.2);
            cursor:pointer;
            transition:all .3s;
            position:relative;
        }
        .profile-avatar-large:active{transform:scale(0.95)}
        .profile-avatar-large img{
            width:100%;
            height:100%;
            object-fit:cover;
            position:absolute;
            top:0;
            left:0;
        }
        .profile-username{
            color:white;
            font-size:clamp(1.2rem, 4vw, 1.5rem);
            font-weight:700;
            margin-bottom:0.5rem;
            word-break:break-word;
        }
        .profile-email{
            color:rgba(255,255,255,0.9);
            font-size:clamp(0.85rem, 2.5vw, 0.9rem);
            word-break:break-word;
        }
        .profile-body{padding:1.5rem 1rem}
        .profile-tabs{
            display:flex;
            gap:0.3rem;
            margin-bottom:1.5rem;
            border-bottom:2px solid var(--border);
            overflow-x:auto;
            -webkit-overflow-scrolling:touch;
        }
        .profile-tab{
            padding:0.8rem 1rem;
            cursor:pointer;
            border:none;
            background:transparent;
            color:var(--text-light);
            font-weight:600;
            transition:all .2s;
            border-bottom:2px solid transparent;
            margin-bottom:-2px;
            white-space:nowrap;
            font-size:0.9rem;
            min-height:48px;
        }
        .profile-tab.active{
            color:var(--primary);
            border-bottom-color:var(--primary);
        }
        .tab-content{display:none}
        .tab-content.active{display:block}
        .stats-grid{
            display:grid;
            grid-template-columns:repeat(2, 1fr);
            gap:0.8rem;
            margin-bottom:1.5rem;
        }
        .stat-card{
            background:var(--glass);
            padding:1rem;
            border-radius:12px;
            text-align:center;
            border:1px solid var(--border);
        }
        .stat-value{
            font-size:clamp(1.3rem, 4vw, 1.8rem);
            font-weight:700;
            background:linear-gradient(135deg,#667eea,#764ba2);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .stat-label{
            color:var(--text-light);
            font-size:clamp(0.75rem, 2vw, 0.85rem);
            margin-top:0.3rem;
        }
        .avatar-grid{
            display:grid;
            grid-template-columns:repeat(auto-fill, minmax(70px, 1fr));
            gap:0.8rem;
            margin-top:1rem;
        }
        .avatar-option{
            aspect-ratio:1;
            border-radius:50%;
            cursor:pointer;
            transition:all .2s;
            overflow:hidden;
            border:3px solid transparent;
            position:relative;
            background:var(--glass);
        }
        .avatar-option img{
            width:100%;
            height:100%;
            object-fit:cover;
        }
        .avatar-option.selected{
            border-color:var(--primary);
            transform:scale(1.05);
        }
        .avatar-option.locked{
            opacity:0.3;
            cursor:not-allowed;
        }
        .avatar-option.locked::after{
            content:'üîí';
            position:absolute;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            font-size:1.5rem;
        }
        .avatar-option:active:not(.locked){transform:scale(0.95)}
        
        /* HERO - Mobile Optimized */
        .hero{
            background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));
            padding:2rem 1rem;
            text-align:center;
            position:relative;
            overflow:hidden;
        }
        .hero::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:url('https://zefirka.club/uploads/posts/2022-10/1664707769_5-zefirka-club-p-banner-dlya-yutub-anime-cherno-belie-5.jpg') center/cover no-repeat;
            opacity:0.2;
            z-index:0;
        }
        .hero>*{position:relative;z-index:1}
        .hero h1{
            font-size:clamp(1.5rem, 6vw, 2rem);
            margin-bottom:0.8rem;
            background:linear-gradient(135deg,#667eea,#764ba2);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .hero p{
            font-size:clamp(0.9rem, 3vw, 1rem);
            line-height:1.6;
        }
        
        /* CONTAINER */
        .container{
            max-width:1200px;
            margin:0 auto;
            padding:1rem;
        }
        
        /* AD CONTAINER */
        .ad-container{
            max-width:1200px;
            margin:1rem auto;
            padding:0.5rem 1rem;
            text-align:center;
            min-height:90px;
            background:var(--glass);
            border-radius:8px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        
        /* MANHVA GRID - Responsive */
        .manhva-grid{
            display:grid;
            grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));
            gap:1rem;
        }
        .manhva-card{
            border-radius:12px;
            overflow:hidden;
            cursor:pointer;
            transition:all .3s;
            box-shadow:0 4px 12px var(--border);
            background:var(--card);
            position:relative;
        }
        .manhva-card:active{transform:scale(0.98)}
        .manhva-cover{
            width:100%;
            aspect-ratio:3/4;
            object-fit:cover;
            background:var(--glass);
        }
        .manhva-info{padding:0.8rem}
        .manhva-title{
            font-weight:700;
            margin-bottom:0.5rem;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
            font-size:clamp(0.9rem, 2.5vw, 1rem);
        }
        .manhva-genre{
            color:var(--text-light);
            font-size:clamp(0.75rem, 2vw, 0.85rem);
            margin-bottom:0.5rem;
        }
        .rating{
            display:flex;
            gap:0.2rem;
            align-items:center;
            flex-wrap:wrap;
        }
        .star{
            cursor:pointer;
            color:#ddd;
            font-size:clamp(0.9rem, 2.5vw, 1.1rem);
            transition:all .2s;
            padding:0.2rem;
        }
        .star:active{transform:scale(1.2)}
        .star.filled{color:#ffd700}
        .star.user-rated{color:#ff6b6b}
        .rating-info{
            font-size:clamp(0.75rem, 2vw, 0.85rem);
            color:var(--text-light);
            margin-left:0.3rem;
        }
        .rating-stars-large .star{
            font-size:clamp(1.2rem, 3vw, 1.5rem);
        }
        
        /* DETAIL VIEW - Mobile Optimized */
        .detail-header{
            display:flex;
            flex-direction:column;
            gap:1.5rem;
            margin-bottom:1.5rem;
        }
        .detail-cover{
            width:100%;
            max-width:300px;
            aspect-ratio:3/4;
            object-fit:cover;
            border-radius:12px;
            box-shadow:0 4px 20px var(--border);
            margin:0 auto;
        }
        .detail-info{width:100%}
        .detail-actions{
            display:flex;
            gap:0.8rem;
            margin:1rem 0;
            flex-wrap:wrap;
        }
        .detail-rating{margin-top:1rem}
        .rating-display{
            display:flex;
            align-items:center;
            gap:1rem;
            margin-bottom:1rem;
            flex-wrap:wrap;
        }
        .rating-number{
            font-size:clamp(2rem, 8vw, 3rem);
            font-weight:700;
            color:var(--primary);
        }
        .user-rating-section{margin-top:1rem}
        
        /* CHAPTER LIST */
        .chapter-item{
            background:var(--card);
            padding:1rem;
            border-radius:8px;
            margin-bottom:0.5rem;
            cursor:pointer;
            transition:all .2s;
            border:1px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:0.5rem;
            min-height:56px;
        }
        .chapter-item:active{transform:scale(0.98)}
        .chapter-item.read{opacity:0.6}
        .show-all-chapters{
            text-align:center;
            margin-top:1rem;
        }
        
        /* LEADERBOARD - Mobile Optimized */
        .podium{
            display:grid;
            grid-template-columns:1fr;
            gap:1rem;
            margin:1rem 0;
            max-width:900px;
            margin:1rem auto;
        }
        .podium-place{
            background:var(--card);
            border-radius:16px;
            padding:1.5rem 1rem;
            text-align:center;
            border:2px solid var(--border);
            transition:all .3s;
            position:relative;
            overflow:hidden;
        }
        .podium-place::before{
            content:'';
            position:absolute;
            top:0;
            left:0;
            right:0;
            height:4px;
            background:linear-gradient(90deg,var(--primary),var(--primary-dark));
        }
        .podium-place:nth-child(1)::before{
            background:linear-gradient(90deg,var(--silver),#e8e8e8);
        }
        .podium-place:nth-child(2)::before{
            background:linear-gradient(90deg,var(--gold),#ffed4e);
        }
        .podium-place:nth-child(3)::before{
            background:linear-gradient(90deg,var(--bronze),#e8a76f);
        }
        .podium-rank{
            position:absolute;
            top:-15px;
            left:50%;
            transform:translateX(-50%);
            width:50px;
            height:50px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:1.5rem;
            font-weight:700;
            border:3px solid var(--card);
            box-shadow:0 4px 15px rgba(0,0,0,0.2);
        }
        .podium-place:nth-child(1) .podium-rank{
            background:linear-gradient(135deg,var(--silver),#e8e8e8);
            color:#333;
        }
        .podium-place:nth-child(2) .podium-rank{
            background:linear-gradient(135deg,var(--gold),#ffed4e);
            color:#333;
        }
        .podium-place:nth-child(3) .podium-rank{
            background:linear-gradient(135deg,var(--bronze),#e8a76f);
            color:#fff;
        }
        .podium-avatar{
            width:clamp(70px, 15vw, 80px);
            height:clamp(70px, 15vw, 80px);
            border-radius:50%;
            margin:2rem auto 1rem;
            overflow:hidden;
            border:4px solid;
            position:relative;
            background:linear-gradient(135deg,#667eea,#764ba2);
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-weight:700;
            font-size:clamp(1.5rem, 4vw, 2rem);
            box-shadow:0 4px 20px rgba(0,0,0,0.2);
        }
        .podium-avatar img{
            width:100%;
            height:100%;
            object-fit:cover;
            position:absolute;
            top:0;
            left:0;
        }
        .podium-place:nth-child(1) .podium-avatar{border-color:var(--silver)}
        .podium-place:nth-child(2) .podium-avatar{border-color:var(--gold)}
        .podium-place:nth-child(3) .podium-avatar{border-color:var(--bronze)}
        .podium-name{
            font-weight:700;
            font-size:clamp(1rem, 3vw, 1.1rem);
            margin-bottom:0.5rem;
            color:var(--text);
            word-break:break-word;
        }
        .podium-time{
            color:var(--text-light);
            font-size:clamp(0.85rem, 2.5vw, 0.95rem);
            font-weight:600;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:0.5rem;
        }
        .leaderboard-list{
            background:var(--card);
            border-radius:12px;
            border:1px solid var(--border);
            overflow:hidden;
            margin-top:1.5rem;
        }
        .leader-item{
            display:flex;
            align-items:center;
            gap:0.8rem;
            padding:1rem;
            border-bottom:1px solid var(--border);
            transition:all .2s;
        }
        .leader-item:active{background:var(--glass)}
        .leader-rank{
            font-weight:700;
            font-size:clamp(1rem, 3vw, 1.2rem);
            min-width:40px;
            text-align:center;
            color:var(--text-light);
        }
        .leader-avatar{
            width:clamp(45px, 10vw, 50px);
            height:clamp(45px, 10vw, 50px);
            border-radius:50%;
            overflow:hidden;
            background:linear-gradient(135deg,#667eea,#764ba2);
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-weight:700;
            font-size:clamp(1rem, 2.5vw, 1.2rem);
            border:2px solid var(--border);
            position:relative;
            flex-shrink:0;
        }
        .leader-avatar img{
            width:100%;
            height:100%;
            object-fit:cover;
            position:absolute;
            top:0;
            left:0;
        }
        .leader-info{
            flex:1;
            min-width:0;
        }
        .leader-name{
            font-weight:700;
            margin-bottom:0.2rem;
            font-size:clamp(0.9rem, 2.5vw, 1rem);
            word-break:break-word;
        }
        .leader-time{
            color:var(--text-light);
            font-size:clamp(0.8rem, 2vw, 0.9rem);
        }
        
        /* COOKIE & WELCOME MODALS */
        .cookie-consent{
            position:fixed;
            bottom:0;
            left:0;
            right:0;
            background:var(--card);
            border-top:2px solid var(--border);
            padding:1rem;
            z-index:3000;
            box-shadow:0 -5px 20px rgba(0,0,0,0.1);
            display:none;
        }
        .cookie-consent.show{display:block}
        .cookie-content{
            max-width:1200px;
            margin:0 auto;
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:1rem;
            flex-wrap:wrap;
        }
        .cookie-text{
            flex:1;
            min-width:200px;
            font-size:clamp(0.85rem, 2vw, 0.95rem);
            line-height:1.6;
        }
        .privacy-link{
            color:var(--primary);
            text-decoration:none;
            font-weight:600;
        }
        .welcome-modal{
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.85);
            backdrop-filter:blur(10px);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:3000;
            animation:fadeIn .5s;
            padding:1rem;
        }
        .welcome-content{
            background:var(--card);
            padding:2rem 1.5rem;
            border-radius:20px;
            max-width:500px;
            width:100%;
            text-align:center;
            box-shadow:0 20px 60px rgba(0,0,0,0.4);
            animation:scaleIn .5s;
        }
        .welcome-content h2{
            font-size:clamp(1.5rem, 5vw, 2rem);
            margin-bottom:1rem;
            background:linear-gradient(135deg,#667eea,#764ba2);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        .welcome-content p{
            color:var(--text-light);
            margin-bottom:1.5rem;
            line-height:1.8;
            font-size:clamp(0.9rem, 2.5vw, 1rem);
        }
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes scaleIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
        
        /* TOAST */
        .toast{
            position:fixed;
            bottom:2rem;
            right:1rem;
            left:1rem;
            background:var(--card);
            padding:1rem;
            border-radius:12px;
            box-shadow:0 10px 40px rgba(0,0,0,0.3);
            display:none;
            z-index:3000;
            border:1px solid var(--border);
            max-width:400px;
            margin:0 auto;
            text-align:center;
            font-size:clamp(0.9rem, 2.5vw, 1rem);
        }
        .toast.show{
            display:block;
            animation:slideInUp .3s;
        }
        @keyframes slideInUp{
            from{opacity:0;transform:translateY(50px)}
            to{opacity:1;transform:translateY(0)}
        }
        
        /* LOADING */
        .loading{
            display:none;
            text-align:center;
            padding:2rem;
        }
        .loading.show{display:block}
        .spinner{
            border:3px solid var(--border);
            border-top:3px solid var(--primary);
            border-radius:50%;
            width:40px;
            height:40px;
            animation:spin .8s linear infinite;
            margin:0 auto;
        }
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* FOOTER */
        footer{
            background:var(--card);
            border-top:1px solid var(--border);
            padding:1.5rem 1rem;
            margin-top:2rem;
        }
        .footer-content{
            max-width:1200px;
            margin:0 auto;
            display:flex;
            justify-content:space-between;
            align-items:center;
            flex-wrap:wrap;
            gap:1rem;
            font-size:clamp(0.85rem, 2vw, 0.95rem);
        }
        .footer-links{
            display:flex;
            gap:1rem;
            flex-wrap:wrap;
        }
        .footer-links a{
            color:var(--text);
            text-decoration:none;
            transition:color .2s;
        }
        .footer-links a:hover{color:var(--primary)}
        
        /* VISIBILITY HELPERS */
        .chapter-list,.reader-container,.bookmarks,.leaderboard{display:none}
        .chapter-list.show,.reader-container.show,.bookmarks.show,.leaderboard.show{display:block}
        
        /* TABLET & UP */
        @media (min-width:768px){
            :root{--header-height:80px}
            nav{padding:1rem;gap:1rem}
            .logo{font-size:1.5rem;gap:0.8rem;padding:0.5rem 1rem}
            .logo-icon{width:40px;height:40px}
            .search-wrapper{max-width:400px}
            .search-results{
                position:absolute;
                top:100%;
                left:0;
                right:0;
                margin-top:0.5rem;
                max-height:400px;
            }
            .btn-text{display:inline}
            .mobile-menu{display:none !important}
            .hamburger{display:none !important}
            .nav-actions{gap:1rem}
            .manhva-grid{
                grid-template-columns:repeat(auto-fill, minmax(160px, 1fr));
                gap:1.5rem;
            }
            .detail-header{
                flex-direction:row;
                gap:2rem;
            }
            .detail-cover{
                width:200px;
                max-width:200px;
            }
            .podium{
                grid-template-columns:repeat(3, 1fr);
                gap:1.5rem;
                margin:2rem auto;
            }
            .podium-place{padding:2rem 1rem}
            .podium-place:nth-child(2){
                order:-1;
                transform:scale(1.1);
                border-width:3px;
            }
            .podium-place:nth-child(2) .podium-rank{
                width:60px;
                height:60px;
                font-size:1.8rem;
            }
            .podium-place:nth-child(2) .podium-avatar{
                width:100px;
                height:100px;
                font-size:2.5rem;
                border-width:5px;
            }
            .profile-modal-content{
                border-radius:20px;
                margin:auto;
                max-height:90vh;
            }
            .profile-header{
                border-radius:20px 20px 0 0;
                padding:2rem;
            }
            .profile-body{padding:2rem}
            .modal-content{padding:2rem}
            .cookie-content{
                flex-direction:row;
                text-align:left;
            }
            .footer-content{
                flex-direction:row;
                text-align:left;
            }
            .toast{
                left:auto;
                right:2rem;
                margin:0;
                text-align:left;
            }
            .stats-grid{grid-template-columns:repeat(2, 1fr)}
            .avatar-grid{
                grid-template-columns:repeat(4, 1fr);
                gap:1rem;
            }
        }
        
        /* MOBILE ONLY STYLES */
        @media (max-width:767px){
            .hamburger{display:flex}
            .nav-actions .btn:not(.btn-icon-only){display:none}
            .user-dropdown{
                right:0.5rem;
                left:0.5rem;
                width:auto;
            }
        }
        
        /* SMALL MOBILE */
        @media (max-width:375px){
            .manhva-grid{
                grid-template-columns:repeat(auto-fill, minmax(120px, 1fr));
                gap:0.8rem;
            }
            .stat-card{padding:0.8rem}
            .avatar-grid{
                grid-template-columns:repeat(auto-fill, minmax(60px, 1fr));
            }
        }
    </style>
</head>
<body data-theme="light">

<!-- WELCOME MODAL -->
<div class="welcome-modal" id="welcomeModal" style="display:none">
    <div class="welcome-content">
        <h2>üéâ Xush kelibsiz!</h2>
        <p>ManhvaUZ - O'zbekistondagi eng yaxshi manhva platformasi!<br><br>
        Davom etish uchun ro'yxatdan o'ting yoki tizimga kiring.</p>
        <button class="btn btn-primary" style="width:100%;margin-bottom:0.5rem" id="welcomeLoginBtn">
            <i class="fas fa-sign-in-alt"></i> Kirish / Ro'yxatdan o'tish
        </button>
        <button class="btn btn-glass" style="width:100%" id="welcomeLaterBtn">
            Keyinroq
        </button>
    </div>
</div>

<!-- COOKIE CONSENT -->
<div class="cookie-consent" id="cookieConsent">
    <div class="cookie-content">
        <div class="cookie-text">
            üç™ Biz saytimizda tajribangizni yaxshilash uchun cookie'lardan foydalanamiz. 
            <a href="#privacy" class="privacy-link" id="privacyLink">Maxfiylik siyosati</a>
        </div>
        <button class="btn btn-primary" id="acceptCookies">Qabul qilish</button>
    </div>
</div>

<!-- AUTH MODAL -->
<div class="modal" id="authModal">
    <div class="modal-content">
        <h2 style="text-align:center;margin-bottom:1.5rem">ManhvaUZ</h2>
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">Kirish</button>
            <button class="auth-tab" data-tab="register">Ro'yxatdan o'tish</button>
        </div>
        <div class="alert alert-error" id="errorMsg"></div>
        <div class="alert alert-success" id="successMsg"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" class="form-input" required autocomplete="email">
            </div>
            <div class="form-group">
                <label>Parol</label>
                <div class="password-toggle">
                    <input type="password" id="loginPass" class="form-input" required autocomplete="current-password">
                    <button type="button" class="toggle-password" data-target="loginPass" aria-label="Ko'rsatish">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <div style="margin-bottom:1rem">
                <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer">
                    <input type="checkbox" id="remember" style="width:20px;height:20px"> Eslab qolish
                </label>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;margin-bottom:0.5rem" id="loginBtn">Kirish</button>
            <button type="button" class="btn btn-glass" style="width:100%" id="closeModal1">Bekor qilish</button>
        </form>
        
        <form id="registerForm" style="display:none">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="regUser" class="form-input" minlength="3" required autocomplete="username">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="regEmail" class="form-input" required autocomplete="email">
            </div>
            <div class="form-group">
                <label>Parol</label>
                <div class="password-toggle">
                    <input type="password" id="regPass" class="form-input" minlength="6" required autocomplete="new-password">
                    <button type="button" class="toggle-password" data-target="regPass" aria-label="Ko'rsatish">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Parolni tasdiqlang</label>
                <div class="password-toggle">
                    <input type="password" id="regPass2" class="form-input" required autocomplete="new-password">
                    <button type="button" class="toggle-password" data-target="regPass2" aria-label="Ko'rsatish">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;margin-bottom:0.5rem" id="regBtn">Ro'yxatdan o'tish</button>
            <button type="button" class="btn btn-glass" style="width:100%" id="closeModal2">Bekor qilish</button>
        </form>
    </div>
</div>

<!-- PROFILE MODAL -->
<div class="profile-modal" id="profileModal">
    <div class="profile-modal-content">
        <div class="profile-header">
            <div class="profile-avatar-large" id="profileAvatarLarge">
                <span id="profileInitial">U</span>
                <img id="profileAvatarImg" style="display:none" alt="Avatar">
            </div>
            <div class="profile-username" id="profileUsername">Username</div>
            <div class="profile-email" id="profileEmail">email@example.com</div>
        </div>
        <div class="profile-body">
            <div class="profile-tabs">
                <button class="profile-tab active" data-tab="stats">Statistika</button>
                <button class="profile-tab" data-tab="edit">Tahrirlash</button>
                <button class="profile-tab" data-tab="avatars">Avatar</button>
            </div>
            
            <div class="tab-content active" id="statsTab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTimeValue">0s</div>
                        <div class="stat-label">Umumiy vaqt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="ratingsCountValue">0</div>
                        <div class="stat-label">Baholar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bookmarksCountValue">0</div>
                        <div class="stat-label">Sevimlilar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="readChaptersValue">0</div>
                        <div class="stat-label">O'qilgan</div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="editTab">
                <form id="editProfileForm">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="editUsername" class="form-input" minlength="3" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editEmail" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%;margin-bottom:0.5rem">Saqlash</button>
                </form>
                <hr style="margin:1.5rem 0;border:none;border-top:1px solid var(--border)">
                <form id="changePasswordForm">
                    <h3 style="margin-bottom:1rem">Parolni o'zgartirish</h3>
                    <div class="form-group">
                        <label>Yangi parol</label>
                        <div class="password-toggle">
                            <input type="password" id="newPassword" class="form-input" minlength="6" required>
                            <button type="button" class="toggle-password" data-target="newPassword" aria-label="Ko'rsatish">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Parolni tasdiqlang</label>
                        <div class="password-toggle">
                            <input type="password" id="confirmPassword" class="form-input" required>
                            <button type="button" class="toggle-password" data-target="confirmPassword" aria-label="Ko'rsatish">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">Parolni o'zgartirish</button>
                </form>
            </div>
            
            <div class="tab-content" id="avatarsTab">
                <p style="margin-bottom:1rem;color:var(--text-light);text-align:center">
                    üéØ Avatarlarni ochish uchun ko'proq vaqt o'tkazing!<br>
                    <small>Sizning vaqtingiz: <strong id="currentUserTime">0s</strong></small>
                </p>
                <div class="avatar-grid" id="avatarGrid"></div>
            </div>
            
            <button class="btn btn-glass" style="width:100%;margin-top:1.5rem" id="closeProfileModal">Yopish</button>
            <button class="btn" style="width:100%;margin-top:0.5rem;background:var(--error);color:white" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Chiqish
            </button>
        </div>
    </div>
</div>

<!-- PRIVACY MODAL -->
<div class="modal" id="privacyModal">
    <div class="modal-content" style="max-width:600px">
        <h2 style="margin-bottom:1rem">Maxfiylik Siyosati</h2>
        <div style="max-height:60vh;overflow-y:auto;margin-bottom:1rem;line-height:1.8;font-size:0.95rem">
            <h3 style="margin-top:1rem">1. Ma'lumotlar yig'ish</h3>
            <p>Biz quyidagi ma'lumotlarni yig'amiz:</p>
            <ul style="margin-left:1.5rem;margin-bottom:1rem">
                <li>Email manzil va username</li>
                <li>Saytdagi faoliyatingiz (o'qilgan chapterlar, baholar)</li>
                <li>Cookie'lar orqali sayt tajribasi</li>
            </ul>
            
            <h3>2. Ma'lumotlardan foydalanish</h3>
            <p>Sizning ma'lumotlaringiz faqat sayt xizmatlarini taqdim etish uchun ishlatiladi.</p>
            
            <h3>3. Cookie'lar</h3>
            <p>Biz sayt tajribasini yaxshilash uchun cookie'lardan foydalanamiz.</p>
            
            <h3>4. Google AdSense</h3>
            <p>Saytimizda Google AdSense reklamalari ko'rsatiladi.</p>
            
            <h3>5. Xavfsizlik</h3>
            <p>Sizning parolingiz shifrlangan holda saqlanadi.</p>
            
            <h3>6. Aloqa</h3>
            <p>Savollar bo'lsa: support@manhvauz.com</p>
        </div>
        <button class="btn btn-glass" style="width:100%" id="closePrivacy">Yopish</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<!-- HEADER -->
<header>
    <nav>
        <div class="logo" id="logoBtn">
            <img class="logo-icon" src="https://w0.peakpx.com/wallpaper/486/994/HD-wallpaper-shadow-ninja-anime-black-ans-white-logo-manga-ninja-symbole.jpg" alt="Logo">
            <span>ManhvaUZ</span>
        </div>
        
        <div class="search-wrapper">
            <input type="text" class="search-box" id="search" placeholder="Qidirish..." autocomplete="off">
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <div class="nav-actions">
            <button class="btn btn-glass" id="bookmarksBtn">
                <i class="far fa-bookmark"></i>
                <span class="btn-text">Sevimlilar</span>
            </button>
            <button class="btn btn-glass" id="leaderboardBtn">
                <i class="fas fa-trophy"></i>
                <span class="btn-text">Liderlar</span>
            </button>
            <button class="theme-btn" id="themeBtn" aria-label="Rejim">
                <i class="fas fa-moon"></i>
            </button>
            <div id="userInfo"></div>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>
</header>

<!-- MOBILE MENU -->
<div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-item" id="mobileBookmarks">
        <i class="far fa-bookmark"></i>
        <span>Sevimlilar</span>
    </div>
    <div class="mobile-menu-item" id="mobileLeaderboard">
        <i class="fas fa-trophy"></i>
        <span>Liderlar Jadvali</span>
    </div>
    <div class="mobile-menu-item" id="mobileProfile">
        <i class="fas fa-user"></i>
        <span>Profil</span>
    </div>
    <div class="mobile-menu-item" id="mobileTheme">
        <i class="fas fa-moon"></i>
        <span>Qorong'i Rejim</span>
    </div>
</div>

<!-- HERO -->
<div class="hero">
    <h1>O'zbek Tilida Manhvalar</h1>
    <p>Eng zo'r manhvalarni bepul o'qing! Turli janrdagi manhvalar, chapterlar va foydalanuvchi baholari bilan.</p>
</div>

<!-- AD SPACE 1 -->
<div class="ad-container">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1670894419218881"
         data-ad-slot="1234567890"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
</div>

<!-- MAIN CONTAINER -->
<div class="container">
    <div id="mainView">
        <div class="manhva-grid" id="grid"></div>
    </div>

    <!-- BOOKMARKS -->
    <div class="bookmarks" id="bookmarks">
        <button class="btn btn-glass" id="backToMain3" style="margin-bottom:1rem">
            <i class="fas fa-arrow-left"></i> Orqaga
        </button>
        <h2 style="text-align:center;margin:1rem 0">‚ù§Ô∏è Sevimli Manhvalar</h2>
        <div class="manhva-grid" id="bookmarkGrid"></div>
    </div>

    <!-- CHAPTER LIST -->
    <div class="chapter-list" id="chapterList">
        <button class="btn btn-glass" id="backToMain" style="margin-bottom:1rem">
            <i class="fas fa-arrow-left"></i> Orqaga
        </button>
        <div class="detail-header">
            <img class="detail-cover" id="detailCover" src="" alt="">
            <div class="detail-info">
                <h2 id="detailTitle" style="font-size:clamp(1.3rem, 5vw, 1.8rem);margin-bottom:0.8rem"></h2>
                <p id="detailDesc" style="font-size:clamp(0.9rem, 2.5vw, 1rem);line-height:1.6"></p>
                <div class="detail-actions">
                    <button class="btn btn-glass" id="bookmarkBtn">
                        <i class="far fa-bookmark"></i> Sevimlilar
                    </button>
                    <button class="btn btn-glass" id="shareBtn">
                        <i class="fas fa-share"></i> Ulashish
                    </button>
                </div>
                <div class="detail-rating">
                    <div class="rating-display">
                        <div class="rating-number" id="avgRating">0.0</div>
                        <div>
                            <div class="rating-stars-large" id="avgStars"></div>
                            <div class="rating-info" id="ratingCount">0 baho</div>
                        </div>
                    </div>
                    <div class="user-rating-section" id="userRatingSection" style="display:none">
                        <p>Sizning bahoyingiz:</p>
                        <div class="rating" id="userRating"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="chapters"></div>
        <div class="show-all-chapters">
            <button class="btn btn-glass" id="showAllChaptersBtn" style="display:none">Barcha chapterlarni ko'rish</button>
        </div>
    </div>

    <!-- READER -->
    <div class="reader-container" id="reader">
        <button class="btn btn-glass" id="backToChapters" style="margin-bottom:1rem">
            <i class="fas fa-arrow-left"></i> Orqaga
        </button>
        <div id="pages"></div>
        <div class="reader-nav" id="readerNav" style="display:flex;justify-content:space-between;align-items:center;padding:1rem;position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);gap:1rem;flex-wrap:wrap"></div>
    </div>

    <!-- LEADERBOARD -->
    <div class="leaderboard" id="leaderboard">
        <button class="btn btn-glass" id="backToMain2" style="margin-bottom:1rem">
            <i class="fas fa-arrow-left"></i> Orqaga
        </button>
        <h2 style="text-align:center;margin-bottom:1.5rem;font-size:clamp(1.3rem, 5vw, 1.8rem)">üèÜ Liderlar Jadvali</h2>
        <div class="podium" id="podium"></div>
        <h3 style="margin:1.5rem 0 1rem;text-align:center;font-size:clamp(1.1rem, 4vw, 1.3rem)">Top 50 Foydalanuvchilar</h3>
        <div class="leaderboard-list" id="leaders"></div>
    </div>

    <!-- LOADING -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="margin-top:1rem">Yuklanmoqda...</p>
    </div>
</div>

<!-- AD SPACE 2 -->
<div class="ad-container">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1670894419218881"
         data-ad-slot="9876543210"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
</div>

<!-- FOOTER -->
<footer>
    <div class="footer-content">
        <div>&copy; 2024 ManhvaUZ. Barcha huquqlar himoyalangan.</div>
        <div class="footer-links">
            <a href="#privacy" id="footerPrivacy">Maxfiylik</a>
            <a href="#terms">Shartlar</a>
            <a href="#contact">Bog'lanish</a>
        </div>
    </div>
</footer>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- GOOGLE ADSENSE -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1670894419218881" crossorigin="anonymous"></script>

<script>
// SUPABASE CONFIG
const supabase = window.supabase.createClient(
    'https://slyvzbqtflcypdiurcju.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNseXZ6YnF0ZmxjeXBkaXVyY2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNzM1MTcsImV4cCI6MjA3NjY0OTUxN30.g4r-gpXptgewpEW0LhI_R7Znr8BSk0UcdTh-QUE8OcE'
);

// GLOBAL STATE
let user = null;
let manhvas = [];
let currentManhva = null;
let currentChapters = [];
let currentChapterIndex = -1;
let userRatings = {};
let userBookmarks = new Set();
let readChapters = new Set();
let avatars = [];
let unlockedAvatars = new Set();
let showAllChapters = false;

const timeTracker = {
    interval: null,
    lastUpdate: Date.now()
};

// INIT
document.addEventListener('DOMContentLoaded', async () => {
    setupAuthEvents();
    setupProfileEvents();
    setupNavigationEvents();
    setupMobileMenu();
    await checkStoredUser();
    await loadManhvas();
    await loadAvatars();
    checkCookieConsent();
    initAds();
    setInterval(() => location.reload(), 3600000);
});

// MOBILE MENU
function setupMobileMenu() {
    const hamburger = document.getElementById('hamburger');
    const mobileMenu = document.getElementById('mobileMenu');
    
    hamburger?.addEventListener('click', () => {
        hamburger.classList.toggle('active');
        mobileMenu.classList.toggle('show');
    });
    
    document.getElementById('mobileBookmarks')?.addEventListener('click', () => {
        closeMobileMenu();
        showBookmarks();
    });
    
    document.getElementById('mobileLeaderboard')?.addEventListener('click', () => {
        closeMobileMenu();
        showLeaderboard();
    });
    
    document.getElementById('mobileProfile')?.addEventListener('click', () => {
        closeMobileMenu();
        if (!user) return openModal();
        openProfileModal();
    });
    
    document.getElementById('mobileTheme')?.addEventListener('click', () => {
        toggleTheme();
        updateMobileThemeText();
    });
    
    // Close on outside click
    document.addEventListener('click', e => {
        if (!hamburger?.contains(e.target) && !mobileMenu?.contains(e.target)) {
            closeMobileMenu();
        }
    });
}

function closeMobileMenu() {
    document.getElementById('hamburger')?.classList.remove('active');
    document.getElementById('mobileMenu')?.classList.remove('show');
}

function updateMobileThemeText() {
    const theme = document.body.dataset.theme;
    const mobileThemeItem = document.getElementById('mobileTheme');
    if (mobileThemeItem) {
        mobileThemeItem.querySelector('i').className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        mobileThemeItem.querySelector('span').textContent = theme === 'light' ? 'Qorong\'i Rejim' : 'Yorug\' Rejim';
    }
}

// ADSENSE INIT
function initAds() {
    try {
        (adsbygoogle = window.adsbygoogle || []).push({});
        (adsbygoogle = window.adsbygoogle || []).push({});
    } catch (e) {
        console.log('AdSense yuklanmadi');
    }
}

// WELCOME MODAL
function showWelcomeModal() {
    document.getElementById('welcomeModal').style.display = 'flex';
}

document.getElementById('welcomeLoginBtn')?.addEventListener('click', () => {
    document.getElementById('welcomeModal').style.display = 'none';
    openModal();
});

document.getElementById('welcomeLaterBtn')?.addEventListener('click', () => {
    document.getElementById('welcomeModal').style.display = 'none';
    localStorage.setItem('welcomeShown', 'true');
});

// COOKIE CONSENT
function checkCookieConsent() {
    if (!localStorage.getItem('cookieConsent')) {
        document.getElementById('cookieConsent').classList.add('show');
    }
}

document.getElementById('acceptCookies').addEventListener('click', () => {
    localStorage.setItem('cookieConsent', 'true');
    document.getElementById('cookieConsent').classList.remove('show');
    showToast('‚úÖ Cookie qabul qilindi', 'success');
});

// PRIVACY MODAL
document.getElementById('privacyLink').addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('privacyModal').classList.add('show');
});

document.getElementById('footerPrivacy').addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('privacyModal').classList.add('show');
});

document.getElementById('closePrivacy').addEventListener('click', () => {
    document.getElementById('privacyModal').classList.remove('show');
});

document.getElementById('privacyModal').addEventListener('click', e => {
    if (e.target.id === 'privacyModal') document.getElementById('privacyModal').classList.remove('show');
});

// AUTH EVENTS
function setupAuthEvents() {
    document.querySelectorAll('.auth-tab').forEach(t => t.addEventListener('click', () => switchAuthTab(t.dataset.tab)));
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
    document.getElementById('closeModal1').addEventListener('click', closeModal);
    document.getElementById('closeModal2').addEventListener('click', closeModal);
    document.getElementById('authModal').addEventListener('click', e => { if (e.target.id === 'authModal') closeModal() });
    document.querySelectorAll('.toggle-password').forEach(b => b.addEventListener('click', togglePassword));
}

// PROFILE EVENTS
function setupProfileEvents() {
    document.querySelectorAll('.profile-tab').forEach(t => t.addEventListener('click', () => switchProfileTab(t.dataset.tab)));
    document.getElementById('closeProfileModal').addEventListener('click', closeProfileModal);
    document.getElementById('profileModal').addEventListener('click', e => { if (e.target.id === 'profileModal') closeProfileModal() });
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    document.getElementById('editProfileForm').addEventListener('submit', handleEditProfile);
    document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
    document.getElementById('profileAvatarLarge').addEventListener('click', () => switchProfileTab('avatars'));
}

// NAVIGATION EVENTS
function setupNavigationEvents() {
    document.getElementById('logoBtn').addEventListener('click', () => {
        closeMobileMenu();
        showMain();
    });
    document.getElementById('bookmarksBtn').addEventListener('click', showBookmarks);
    document.getElementById('leaderboardBtn').addEventListener('click', showLeaderboard);
    document.getElementById('themeBtn').addEventListener('click', toggleTheme);
    document.getElementById('search').addEventListener('input', handleSearch);
    document.getElementById('backToMain').addEventListener('click', showMain);
    document.getElementById('backToMain2').addEventListener('click', showMain);
    document.getElementById('backToMain3').addEventListener('click', showMain);
}

async function checkStoredUser() {
    const stored = localStorage.getItem('user') || sessionStorage.getItem('user');
    if (stored) {
        user = JSON.parse(stored);
        updateUserUI();
        startTimeTracking();
        await syncUserData();
    } else {
        if (!localStorage.getItem('welcomeShown')) {
            setTimeout(showWelcomeModal, 1000);
        }
    }
}

function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
    clearAlerts();
}

function togglePassword() {
    const target = document.getElementById(this.dataset.target);
    const icon = this.querySelector('i');
    if (target.type === 'password') {
        target.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        target.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

async function handleLogin(e) {
    e.preventDefault();
    clearAlerts();
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPass').value;
    const remember = document.getElementById('remember').checked;

    if (!email || !password) return showAlert('error', 'Barcha maydonlarni to\'ldiring');

    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yuklanmoqda...';

    try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;

        const { data: userData } = await supabase.from('users').select('*').eq('id', data.user.id).single();
        user = userData;

        const storage = remember ? localStorage : sessionStorage;
        storage.setItem('user', JSON.stringify(user));

        await syncUserData();
        updateUserUI();
        startTimeTracking();
        showToast('üéâ Xush kelibsiz!', 'success');
        closeModal();
        renderManhvas(manhvas);
    } catch (error) {
        showAlert('error', error.message.includes('Invalid') ? 'Email yoki parol xato' : error.message);
    } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = 'Kirish';
    }
}

async function handleRegister(e) {
    e.preventDefault();
    clearAlerts();
    const username = document.getElementById('regUser').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPass').value;
    const password2 = document.getElementById('regPass2').value;

    if (!username || !email || !password || !password2) return showAlert('error', 'Barcha maydonlarni to\'ldiring');
    if (username.length < 3) return showAlert('error', 'Username kamida 3 belgi');
    if (password.length < 6) return showAlert('error', 'Parol kamida 6 belgi');
    if (password !== password2) return showAlert('error', 'Parollar mos kelmadi');

    const regBtn = document.getElementById('regBtn');
    regBtn.disabled = true;
    regBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yuklanmoqda...';

    try {
        const { data: existing } = await supabase.from('users').select('username').eq('username', username).maybeSingle();
        if (existing) return showAlert('error', 'Bu username band');

        const { data: authData, error } = await supabase.auth.signUp({
            email,
            password,
            options: { data: { username } }
        });

        if (error) throw error;

        if (!authData.session) {
            showAlert('success', 'Emailni tasdiqlang');
            setTimeout(() => switchAuthTab('login'), 2000);
            return;
        }

        const { error: insertError } = await supabase.from('users').insert({
            id: authData.user.id,
            username,
            email,
            total_time: 0
        });

        if (insertError) throw insertError;

        showAlert('success', 'Muvaffaqiyatli!');
        setTimeout(() => switchAuthTab('login'), 1500);
    } catch (error) {
        showAlert('error', error.message);
    } finally {
        regBtn.disabled = false;
        regBtn.textContent = 'Ro\'yxatdan o\'tish';
    }
}

function handleLogout() {
    if (confirm('Haqiqatan ham chiqmoqchimisiz?')) {
        if (timeTracker.interval) {
            clearInterval(timeTracker.interval);
            saveTime();
        }
        localStorage.removeItem('user');
        sessionStorage.removeItem('user');
        user = null;
        userRatings = {};
        userBookmarks.clear();
        readChapters.clear();
        unlockedAvatars.clear();
        updateUserUI();
        closeProfileModal();
        showMain();
        showToast('üëã Xayr!', 'success');
    }
}

function switchProfileTab(tab) {
    document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.profile-tab[data-tab="${tab}"]`).classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`${tab}Tab`).classList.add('active');
}

function openProfileModal() {
    if (!user) return openModal();
    renderProfile();
    document.getElementById('profileModal').classList.add('show');
}

function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('show');
}

async function renderProfile() {
    const initial = user.username[0].toUpperCase();
    document.getElementById('profileUsername').textContent = user.username;
    document.getElementById('profileEmail').textContent = user.email;
    renderAvatar(document.getElementById('profileAvatarLarge'), user.avatar_url, initial, '100px');

    document.getElementById('totalTimeValue').textContent = formatTime(user.total_time || 0);
    document.getElementById('ratingsCountValue').textContent = Object.keys(userRatings).length;
    document.getElementById('bookmarksCountValue').textContent = userBookmarks.size;
    document.getElementById('readChaptersValue').textContent = readChapters.size;

    document.getElementById('editUsername').value = user.username;
    document.getElementById('editEmail').value = user.email;

    document.getElementById('currentUserTime').textContent = formatTime(user.total_time || 0);

    await checkUnlockedAvatars();
    renderAvatars();
}

async function handleEditProfile(e) {
    e.preventDefault();
    const username = document.getElementById('editUsername').value.trim();
    const email = document.getElementById('editEmail').value.trim();

    if (!username || !email) return showToast('Barcha maydonlarni to\'ldiring', 'error');
    if (username.length < 3) return showToast('Username kamida 3 belgi', 'error');

    try {
        if (username !== user.username) {
            const { data: existing } = await supabase.from('users').select('username').eq('username', username).maybeSingle();
            if (existing && existing.id !== user.id) return showToast('Bu username band', 'error');
        }

        const { error } = await supabase.from('users').update({ username, email }).eq('id', user.id);
        if (error) throw error;

        user.username = username;
        user.email = email;
        localStorage.setItem('user', JSON.stringify(user));

        renderProfile();
        updateUserUI();
        showToast('‚úÖ Saqlandi!', 'success');
    } catch (error) {
        showToast('‚ùå Xatolik', 'error');
    }
}

async function handleChangePassword(e) {
    e.preventDefault();
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;

    if (!newPass || !confirmPass) return showToast('Barcha maydonlarni to\'ldiring', 'error');
    if (newPass.length < 6) return showToast('Parol kamida 6 belgi', 'error');
    if (newPass !== confirmPass) return showToast('Parollar mos kelmadi', 'error');

    try {
        const { error } = await supabase.auth.updateUser({ password: newPass });
        if (error) throw error;

        document.getElementById('changePasswordForm').reset();
        showToast('‚úÖ Parol o\'zgartirildi!', 'success');
    } catch (error) {
        showToast('‚ùå Xatolik', 'error');
    }
}

function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0) return `${h}s ${m}m`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
}

function updateUserUI() {
    const userInfo = document.getElementById('userInfo');
    if (!user) {
        userInfo.innerHTML = '<button class="btn btn-primary btn-icon-only" id="loginShowBtn"><i class="fas fa-sign-in-alt"></i></button>';
        document.getElementById('loginShowBtn').addEventListener('click', openModal);
        return;
    }

    const initial = user.username[0].toUpperCase();
    userInfo.innerHTML = `
        <div class="user-avatar" id="userAvatar"></div>
        <div class="user-dropdown" id="userDropdown">
            <div class="dropdown-item" id="profileBtn"><i class="fas fa-user"></i> Profil</div>
            <div class="dropdown-item" id="closeDropdownBtn"><i class="fas fa-times"></i> Yopish</div>
        </div>
    `;

    renderAvatar(document.getElementById('userAvatar'), user.avatar_url, initial, '44px');

    document.getElementById('userAvatar').addEventListener('click', toggleUserDropdown);
    document.getElementById('profileBtn').addEventListener('click', () => {
        toggleUserDropdown();
        openProfileModal();
    });
    document.getElementById('closeDropdownBtn').addEventListener('click', toggleUserDropdown);
}

function toggleUserDropdown() {
    document.getElementById('userDropdown')?.classList.toggle('show');
}

document.addEventListener('click', e => {
    const dropdown = document.getElementById('userDropdown');
    const avatar = document.getElementById('userAvatar');
    if (dropdown && !dropdown.contains(e.target) && !avatar?.contains(e.target)) {
        dropdown.classList.remove('show');
    }
});

function startTimeTracking() {
    if (!user || timeTracker.interval) return;
    timeTracker.lastUpdate = Date.now();
    timeTracker.interval = setInterval(saveTime, 30000);
}

async function saveTime() {
    if (!user) return;
    const now = Date.now();
    const elapsed = Math.floor((now - timeTracker.lastUpdate) / 1000);
    if (elapsed > 0) {
        user.total_time += elapsed;
        timeTracker.lastUpdate = now;
        await supabase.from('users').update({ total_time: user.total_time }).eq('id', user.id);
        const storage = localStorage.getItem('user') ? localStorage : sessionStorage;
        storage.setItem('user', JSON.stringify(user));
        await checkUnlockedAvatars();
        if (document.getElementById('profileModal').classList.contains('show')) {
            document.getElementById('totalTimeValue').textContent = formatTime(user.total_time || 0);
            document.getElementById('currentUserTime').textContent = formatTime(user.total_time || 0);
            renderAvatars();
        }
    }
}

async function loadAvatars() {
    try {
        const { data } = await supabase.from('avatars').select('*').order('required_time');
        avatars = data || [];
        if (user) await checkUnlockedAvatars();
    } catch (error) {
        console.error('Avatar yuklash xatosi:', error);
    }
}

async function checkUnlockedAvatars() {
    if (!user) return;
    const previousSize = unlockedAvatars.size;
    unlockedAvatars.clear();
    avatars.forEach(avatar => {
        if ((user.total_time || 0) >= avatar.required_time) {
            unlockedAvatars.add(avatar.id);
        }
    });
    if (unlockedAvatars.size > previousSize) {
        showToast('üéâ Yangi avatar ochildi!', 'success');
    }
}

function renderAvatars() {
    const grid = document.getElementById('avatarGrid');
    if (!avatars.length) return grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--text-light)">Avatarlar yuklanmadi</p>';

    grid.innerHTML = avatars.map(avatar => {
        const unlocked = unlockedAvatars.has(avatar.id);
        const selected = user.avatar_url === avatar.url;
        return `<div class="avatar-option ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}" data-id="${avatar.id}" data-url="${avatar.url}" title="${unlocked ? avatar.name : `Kerak: ${formatTime(avatar.required_time)}`}">
            ${unlocked ? `<img src="${avatar.url}" onerror="this.style.display='none';" alt="${avatar.name}">` : ''}
        </div>`;
    }).join('');

    document.querySelectorAll('.avatar-option:not(.locked)').forEach(option => option.addEventListener('click', () => selectAvatar(option.dataset.url)));
}

async function selectAvatar(url) {
    try {
        const { error } = await supabase.from('users').update({ avatar_url: url }).eq('id', user.id);
        if (error) throw error;

        user.avatar_url = url;
        const storage = localStorage.getItem('user') ? localStorage : sessionStorage;
        storage.setItem('user', JSON.stringify(user));

        renderProfile();
        updateUserUI();
        showToast('‚úÖ Avatar o\'zgartirildi!', 'success');
    } catch (error) {
        showToast('‚ùå Xatolik', 'error');
    }
}

function renderAvatar(container, url, initial, size = '44px') {
    const hasUrl = url && url.trim() !== '';
    container.innerHTML = hasUrl ?
        `<img src="${url}" alt="Avatar" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" style="width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0"><span style="display:none;width:100%;height:100%;display:flex;align-items:center;justify-content:center">${initial}</span>` :
        `<span style="width:100%;height:100%;display:flex;align-items:center;justify-content:center">${initial}</span>`;
}

async function loadManhvas() {
    showLoading(true);
    try {
        const { data } = await supabase.from('manhvas').select('*').order('created_at', { ascending: false });
        manhvas = data || [];
        await loadAllRatings();
        manhvas.sort((a, b) => (b.avg_rating || 0) - (a.avg_rating || 0));
        renderManhvas(manhvas);
    } catch (error) {
        showToast('‚ùå Manhvalarni yuklashda xatolik', 'error');
    } finally {
        showLoading(false);
    }
}

async function loadAllRatings() {
    try {
        const { data } = await supabase.from('ratings').select('*');
        if (data) {
            const ratingMap = {};
            data.forEach(r => {
                if (!ratingMap[r.manhva_id]) ratingMap[r.manhva_id] = [];
                ratingMap[r.manhva_id].push(r.rating);
                if (user && r.user_id === user.id) userRatings[r.manhva_id] = r.rating;
            });
            manhvas.forEach(m => {
                const ratings = ratingMap[m.id] || [];
                m.avg_rating = ratings.length ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;
                m.rating_count = ratings.length;
            });
        }
    } catch (error) {
        console.error('Ratinglarni yuklash xatosi:', error);
    }
}

async function syncUserData() {
    if (!user) return;
    try {
        const [bookmarks, ratings, reads] = await Promise.all([
            supabase.from('bookmarks').select('manhva_id').eq('user_id', user.id),
            supabase.from('ratings').select('*').eq('user_id', user.id),
            supabase.from('read_chapters').select('chapter_id').eq('user_id', user.id)
        ]);

        userBookmarks = new Set(bookmarks.data?.map(b => b.manhva_id) || []);
        userRatings = {};
        ratings.data?.forEach(r => userRatings[r.manhva_id] = r.rating);
        readChapters = new Set(reads.data?.map(r => r.chapter_id) || []);
    } catch (error) {
        console.error('Sync xatosi:', error);
    }
}

function renderManhvas(list) {
    const grid = document.getElementById('grid');
    if (!list.length) return grid.innerHTML = '<p style="text-align:center;color:var(--text-light);grid-column:1/-1">Topilmadi</p>';

    grid.innerHTML = list.map(m => {
        const avg = m.avg_rating || 0;
        const userRate = user ? (userRatings[m.id] || 0) : 0;
        const bookmark = user && userBookmarks.has(m.id);

        return `<div class="manhva-card" data-id="${m.id}">
            ${bookmark ? '<div style="position:absolute;top:10px;right:10px;font-size:1.2rem;z-index:1"><i class="fas fa-heart" style="color:var(--error)"></i></div>' : ''}
            <img class="manhva-cover" src="${m.cover_url || 'https://via.placeholder.com/300x400?text=' + encodeURIComponent(m.title)}" loading="lazy" alt="${m.title}">
            <div class="manhva-info">
                <div class="manhva-title">${m.title}</div>
                <div class="manhva-genre">${m.genre}</div>
                <div class="rating" data-manhva-id="${m.id}">
                    ${[1, 2, 3, 4, 5].map(i => `<span class="star ${i <= Math.round(avg) ? 'filled' : ''} ${userRate === i ? 'user-rated' : ''}" data-rating="${i}"><i class="fas fa-star"></i></span>`).join('')}
                    <span class="rating-info">${avg.toFixed(1)}</span>
                </div>
            </div>
        </div>`;
    }).join('');

    document.querySelectorAll('.manhva-card').forEach(card => card.addEventListener('click', e => { if (!e.target.closest('.star')) showDetail(parseInt(card.dataset.id)) }));
    document.querySelectorAll('.rating .star').forEach(star => star.addEventListener('click', e => { e.stopPropagation(); rateManhva(parseInt(star.closest('.rating').dataset.manhvaId), parseInt(star.dataset.rating)) }));
}

async function rateManhva(id, rating) {
    if (!user) return openModal();

    try {
        const { data: existing } = await supabase.from('ratings').select('*').eq('manhva_id', id).eq('user_id', user.id).maybeSingle();

        if (existing) {
            await supabase.from('ratings').update({ rating }).eq('manhva_id', id).eq('user_id', user.id);
        } else {
            await supabase.from('ratings').insert({ manhva_id: id, user_id: user.id, rating });
        }

        userRatings[id] = rating;
        await loadAllRatings();
        renderManhvas(manhvas);
        showToast('‚≠ê Baholandi!', 'success');
    } catch (error) {
        showToast('‚ùå Xatolik', 'error');
    }
}

function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    const results = document.getElementById('searchResults');

    if (!query) return results.classList.remove('show');

    const filtered = manhvas.filter(m => m.title.toLowerCase().includes(query) || m.genre.toLowerCase().includes(query)).slice(0, 5);

    if (!filtered.length) {
        results.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-light)">Hech narsa topilmadi</div>';
        results.classList.add('show');
        return;
    }

    results.innerHTML = filtered.map(m => `
        <div class="search-result-item" data-id="${m.id}">
            <img class="search-result-cover" src="${m.cover_url || 'https://via.placeholder.com/50x65'}" alt="${m.title}">
            <div style="flex:1;min-width:0">
                <div style="font-weight:700">${m.title}</div>
                <div style="color:var(--text-light);font-size:0.85rem">${m.genre}</div>
                <div style="color:var(--text-light);font-size:0.85rem">
                    <i class="fas fa-star" style="color:#ffd700"></i> ${(m.avg_rating || 0).toFixed(1)} (${m.rating_count || 0})
                </div>
            </div>
        </div>
    `).join('');

    results.classList.add('show');

    document.querySelectorAll('.search-result-item').forEach(item => item.addEventListener('click', () => {
        showDetail(parseInt(item.dataset.id));
        results.classList.remove('show');
        document.getElementById('search').value = '';
    }));
}

async function showDetail(id) {
    closeMobileMenu();
    showLoading(true);
    currentManhva = manhvas.find(m => m.id === id);

    if (!currentManhva) {
        showLoading(false);
        return;
    }

    hideAllViews();
    document.getElementById('chapterList').classList.add('show');

    document.getElementById('detailCover').src = currentManhva.cover_url;
    document.getElementById('detailTitle').textContent = currentManhva.title;
    document.getElementById('detailDesc').textContent = currentManhva.description || 'Tavsif yo\'q';

    document.getElementById('avgRating').textContent = (currentManhva.avg_rating || 0).toFixed(1);
    document.getElementById('avgStars').innerHTML = [1, 2, 3, 4, 5].map(i => `<span class="star ${i <= Math.round(currentManhva.avg_rating || 0) ? 'filled' : ''}"><i class="fas fa-star"></i></span>`).join('');
    document.getElementById('ratingCount').textContent = `${currentManhva.rating_count || 0} baho`;

    const bookmarkBtn = document.getElementById('bookmarkBtn');
    bookmarkBtn.innerHTML = userBookmarks.has(id) ? '<i class="fas fa-heart"></i> Sevimlilardan' : '<i class="far fa-bookmark"></i> Sevimlilar';
    bookmarkBtn.onclick = () => toggleBookmark(id);

    document.getElementById('shareBtn').onclick = () => {
        if (navigator.share) {
            navigator.share({
                title: currentManhva.title,
                text: currentManhva.description,
                url: window.location.href
            }).catch(() => {});
        } else {
            navigator.clipboard.writeText(window.location.href);
            showToast('üîó Link nusxalandi!', 'success');
        }
    };

    if (user) {
        document.getElementById('userRatingSection').style.display = 'block';
        const userRate = userRatings[id] || 0;
        document.getElementById('userRating').innerHTML = [1, 2, 3, 4, 5].map(i => `<span class="star ${i <= userRate ? 'filled' : ''}" data-rating="${i}"><i class="fas fa-star"></i></span>`).join('');
        document.querySelectorAll('#userRating .star').forEach(star => star.addEventListener('click', () => rateManhva(id, parseInt(star.dataset.rating))));
    } else {
        document.getElementById('userRatingSection').style.display = 'none';
    }

    await loadChapters(id);
    showLoading(false);
}

async function loadChapters(manhvaId) {
    try {
        const { data } = await supabase.from('chapters').select('*').eq('manhva_id', manhvaId).order('chapter_number');
        currentChapters = data || [];
        showAllChapters = false;
        renderChapters();
    } catch (error) {
        showToast('‚ùå Chapterlar yuklanmadi', 'error');
    }
}

function renderChapters() {
    const container = document.getElementById('chapters');
    const showAllBtn = document.getElementById('showAllChaptersBtn');

    if (!currentChapters.length) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-light)">Chapterlar yo\'q</p>';
        showAllBtn.style.display = 'none';
        return;
    }

    const displayChapters = showAllChapters ? currentChapters : currentChapters.slice(0, 1);

    container.innerHTML = displayChapters.map(ch => `
        <div class="chapter-item ${readChapters.has(ch.id) ? 'read' : ''}" data-index="${currentChapters.indexOf(ch)}">
            <span>Chapter ${ch.chapter_number}: ${ch.title || ''}</span>
            ${readChapters.has(ch.id) ? '<span style="color:var(--success)"><i class="fas fa-check"></i></span>' : ''}
        </div>
    `).join('');

    document.querySelectorAll('.chapter-item').forEach(item => item.addEventListener('click', () => openReader(parseInt(item.dataset.index))));

    if (currentChapters.length > 1) {
        showAllBtn.style.display = 'block';
        showAllBtn.textContent = showAllChapters ? 'Kamroq ko\'rish' : `Barcha chapterlarni ko\'rish (${currentChapters.length})`;
        showAllBtn.onclick = () => {
            showAllChapters = !showAllChapters;
            renderChapters();
        };
    } else {
        showAllBtn.style.display = 'none';
    }
}

async function openReader(index) {
    currentChapterIndex = index;
    const chapter = currentChapters[index];

    hideAllViews();
    document.getElementById('reader').classList.add('show');
    showLoading(true);

    try {
        const { data } = await supabase.from('pages').select('*').eq('chapter_id', chapter.id).order('page_number');
        const pages = data || [];

        document.getElementById('pages').innerHTML = pages.map(p => `<img src="${p.image_url}" style="width:100%;max-width:800px;margin:0 auto 1rem;display:block" alt="Page ${p.page_number}" loading="lazy">`).join('');

        renderReaderNav();

        if (user && !readChapters.has(chapter.id)) {
            await supabase.from('read_chapters').insert({ user_id: user.id, chapter_id: chapter.id });
            readChapters.add(chapter.id);
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
        showToast('‚ùå Sahifalar yuklanmadi', 'error');
    } finally {
        showLoading(false);
    }
}

function renderReaderNav() {
    const nav = document.getElementById('readerNav');
    const hasPrev = currentChapterIndex > 0;
    const hasNext = currentChapterIndex < currentChapters.length - 1;

    nav.innerHTML = `
        <button class="btn btn-glass" ${!hasPrev ? 'disabled' : ''} id="prevChapter">
            <i class="fas fa-chevron-left"></i> Oldingi
        </button>
        <span style="font-weight:600;text-align:center">Chapter ${currentChapters[currentChapterIndex].chapter_number}</span>
        <button class="btn btn-glass" ${!hasNext ? 'disabled' : ''} id="nextChapter">
            Keyingi <i class="fas fa-chevron-right"></i>
        </button>
    `;

    if (hasPrev) document.getElementById('prevChapter').onclick = () => openReader(currentChapterIndex - 1);
    if (hasNext) document.getElementById('nextChapter').onclick = () => openReader(currentChapterIndex + 1);
}

document.getElementById('backToChapters').addEventListener('click', () => showDetail(currentManhva.id));

async function toggleBookmark(id) {
    if (!user) return openModal();

    try {
        if (userBookmarks.has(id)) {
            await supabase.from('bookmarks').delete().eq('user_id', user.id).eq('manhva_id', id);
            userBookmarks.delete(id);
            showToast('‚ùå Sevimlilardan o\'chirildi', 'success');
        } else {
            await supabase.from('bookmarks').insert({ user_id: user.id, manhva_id: id });
            userBookmarks.add(id);
            showToast('‚ù§Ô∏è Sevimlilarga qo\'shildi!', 'success');
        }

        const bookmarkBtn = document.getElementById('bookmarkBtn');
        bookmarkBtn.innerHTML = userBookmarks.has(id) ? '<i class="fas fa-heart"></i> Sevimlilardan' : '<i class="far fa-bookmark"></i> Sevimlilar';
    } catch (error) {
        showToast('‚ùå Xatolik', 'error');
    }
}

function showBookmarks() {
    if (!user) return openModal();

    closeMobileMenu();
    hideAllViews();
    document.getElementById('bookmarks').classList.add('show');

    const bookmarked = manhvas.filter(m => userBookmarks.has(m.id));
    const grid = document.getElementById('bookmarkGrid');

    if (!bookmarked.length) {
        grid.innerHTML = '<p style="text-align:center;color:var(--text-light);grid-column:1/-1;padding:2rem">üíî Sevimlilar bo\'sh</p>';
    } else {
        grid.innerHTML = bookmarked.map(m => {
            const avg = m.avg_rating || 0;
            const userRate = user ? (userRatings[m.id] || 0) : 0;
            return `<div class="manhva-card" data-id="${m.id}">
                <div style="position:absolute;top:10px;right:10px;font-size:1.2rem;z-index:1"><i class="fas fa-heart" style="color:var(--error)"></i></div>
                <img class="manhva-cover" src="${m.cover_url || 'https://via.placeholder.com/300x400?text=' + encodeURIComponent(m.title)}" loading="lazy" alt="${m.title}">
                <div class="manhva-info">
                    <div class="manhva-title">${m.title}</div>
                    <div class="manhva-genre">${m.genre}</div>
                    <div class="rating" data-manhva-id="${m.id}">
                        ${[1, 2, 3, 4, 5].map(i => `<span class="star ${i <= Math.round(avg) ? 'filled' : ''} ${userRate === i ? 'user-rated' : ''}" data-rating="${i}"><i class="fas fa-star"></i></span>`).join('')}
                        <span class="rating-info">${avg.toFixed(1)}</span>
                    </div>
                </div>
            </div>`;
        }).join('');

        document.querySelectorAll('#bookmarkGrid .manhva-card').forEach(card => card.addEventListener('click', e => { if (!e.target.closest('.star')) showDetail(parseInt(card.dataset.id)) }));
        document.querySelectorAll('#bookmarkGrid .rating .star').forEach(star => star.addEventListener('click', e => { e.stopPropagation(); rateManhva(parseInt(star.closest('.rating').dataset.manhvaId), parseInt(star.dataset.rating)) }));
    }
}

async function showLeaderboard() {
    closeMobileMenu();
    hideAllViews();
    document.getElementById('leaderboard').classList.add('show');
    showLoading(true);

    try {
        const { data } = await supabase.from('users').select('*').order('total_time', { ascending: false }).limit(50);
        const leaders = data || [];

        const podium = document.getElementById('podium');
        if (leaders.length >= 3) {
            const top3 = [leaders[1], leaders[0], leaders[2]];
            podium.innerHTML = top3.map((u, i) => {
                const rank = i === 1 ? 1 : i === 0 ? 2 : 3;
                const initial = u.username[0].toUpperCase();
                const medal = ['ü•à', 'ü•á', 'ü•â'][i];
                return `<div class="podium-place">
                    <div class="podium-rank">${medal}</div>
                    <div class="podium-avatar">
                        ${u.avatar_url ? `<img src="${u.avatar_url}" alt="${u.username}" onerror="this.style.display='none'">` : ''}
                        <span style="display:${u.avatar_url ? 'none' : 'flex'};width:100%;height:100%;align-items:center;justify-content:center">${initial}</span>
                    </div>
                    <div class="podium-name">${u.username}</div>
                    <div class="podium-time"><i class="fas fa-clock"></i> ${formatTime(u.total_time || 0)}</div>
                </div>`;
            }).join('');
        } else {
            podium.innerHTML = '<p style="text-align:center;color:var(--text-light);grid-column:1/-1">Yetarli foydalanuvchilar yo\'q</p>';
        }

        const rest = leaders.slice(3);
        const list = document.getElementById('leaders');

        if (!rest.length) {
            list.style.display = 'none';
        } else {
            list.style.display = 'block';
            list.innerHTML = rest.map((u, i) => {
                const rank = i + 4;
                const initial = u.username[0].toUpperCase();
                const isCurrentUser = user && u.id === user.id;
                return `<div class="leader-item" style="${isCurrentUser ? 'background:var(--glass)' : ''}">
                    <div class="leader-rank">${rank}</div>
                    <div class="leader-avatar">
                        ${u.avatar_url ? `<img src="${u.avatar_url}" alt="${u.username}" onerror="this.style.display='none'">` : ''}
                        <span style="display:${u.avatar_url ? 'none' : 'flex'};width:100%;height:100%;align-items:center;justify-content:center">${initial}</span>
                    </div>
                    <div class="leader-info">
                        <div class="leader-name">${u.username} ${isCurrentUser ? '(Siz)' : ''}</div>
                        <div class="leader-time">${formatTime(u.total_time || 0)}</div>
                    </div>
                </div>`;
            }).join('');
        }
    } catch (error) {
        showToast('‚ùå Liderlar yuklanmadi', 'error');
    } finally {
        showLoading(false);
    }
}

function hideAllViews() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('chapterList').classList.remove('show');
    document.getElementById('reader').classList.remove('show');
    document.getElementById('bookmarks').classList.remove('show');
    document.getElementById('leaderboard').classList.remove('show');
}

function showMain() {
    closeMobileMenu();
    hideAllViews();
    document.getElementById('mainView').style.display = 'block';
    renderManhvas(manhvas);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function toggleTheme() {
    const current = document.body.dataset.theme;
    const next = current === 'light' ? 'dark' : 'light';
    document.body.dataset.theme = next;
    document.getElementById('themeBtn').innerHTML = next === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
    localStorage.setItem('theme', next);
    updateMobileThemeText();
}

const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
    document.body.dataset.theme = savedTheme;
    document.getElementById('themeBtn').innerHTML = savedTheme === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
}

function openModal() {
    closeMobileMenu();
    document.getElementById('authModal').classList.add('show');
    clearAlerts();
}

function closeModal() {
    document.getElementById('authModal').classList.remove('show');
    clearAlerts();
}

function showAlert(type, msg) {
    const id = type === 'error' ? 'errorMsg' : 'successMsg';
    const el = document.getElementById(id);
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function clearAlerts() {
    document.getElementById('errorMsg').classList.remove('show');
    document.getElementById('successMsg').classList.remove('show');
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('show', show);
}

function showToast(msg, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.background = type === 'error' ? 'var(--error)' : type === 'success' ? 'var(--success)' : 'var(--card)';
    toast.style.color = type === 'error' || type === 'success' ? 'white' : 'var(--text)';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

document.addEventListener('click', e => {
    const searchBox = document.getElementById('search');
    const searchResults = document.getElementById('searchResults');
    if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.remove('show');
    }
});

window.addEventListener('beforeunload', () => {
    if (user && timeTracker.interval) saveTime();
});
</script>

</body>
</html>